---
import { getCollection } from 'astro:content';
import { CATEGORY_COLOR_MAP, DEFAULT_BRAND_COLOR, formatDateCN } from '../utils/constants';

interface Props {
  class?: string;
}

const { class: className = '' } = Astro.props;

// Get featured blogs from content collection
const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const featuredPosts = allPosts
  .filter(post => post.data.featured === true)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// First post as main (large card), next 2 as side (small cards)
const mainPost = featuredPosts[0];
const sidePosts = featuredPosts.slice(1, 3);

// Get color for a post
function getPostColor(categories: string[] = []): string {
  const firstCategory = categories[0];
  return CATEGORY_COLOR_MAP[firstCategory] || DEFAULT_BRAND_COLOR;
}
---

{featuredPosts.length > 0 && (
  <section class:list={["featured-posts py-24 md:py-[96px] border-t border-[#262626]", className]}>
    <div class="container-wide">
      <!-- Section Header -->
      <div class="flex items-center justify-between mb-8">
        <h2 class="section-title-premium" style="font-family: var(--font-display) !important;">精选博客</h2>
        <a
          href="/blog"
          class="text-[#A855F7] hover:underline transition-all"
        >
          查看全部 →
        </a>
      </div>

      <!-- Posts Grid -->
      <div class="featured-grid grid grid-cols-1 md:grid-cols-2 md:grid-rows-2 gap-6">
        <!-- Main Large Card -->
        {mainPost && (
          <a href={`/blog/${mainPost.slug}`} class="block md:row-span-2 h-full">
            <article
              class="post-card post-card--large group rounded-2xl overflow-hidden card-premium hover:-translate-y-1 transition-all duration-300 h-full flex flex-col"
              style={`--hover-color: ${getPostColor(mainPost.data.categories)}`}
            >
              <div
                class="post-image flex-1 relative flex items-start justify-start p-6 overflow-hidden min-h-[200px]"
              >
                {mainPost.data.image && (
                  <img
                    src={mainPost.data.image}
                    alt={mainPost.data.title}
                    class="absolute inset-0 w-full h-full object-cover"
                  />
                )}
                <!-- Diagonal decorative line -->
                <div class="absolute inset-0 pointer-events-none">
                  <div
                    class="absolute top-1/2 left-0 w-[200%] h-[1px]"
                    style="
                      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                      transform: rotate(-45deg) translateY(-50%);
                      transform-origin: left center;
                    "
                  ></div>
                </div>
                <span
                  class="post-tag relative z-10 inline-block text-white text-xs px-3 py-1 rounded-md"
                  style={`
                    background: rgba(0,0,0,0.4);
                    backdrop-filter: blur(4px);
                    border: 1px solid ${getPostColor(mainPost.data.categories)};
                  `}
                >
                  {mainPost.data.categories[0] || '博客'}
                </span>
              </div>
              <div class="post-content p-6">
                <h3
                  class="text-xl font-bold text-white mb-2 transition-colors"
                  style="font-weight: 700;"
                >
                  {mainPost.data.title}
                </h3>
                <p class="text-[#a3a3a3] text-base mb-4">
                  {mainPost.data.description}
                </p>
                <div class="post-meta text-[#525252] text-[13px] flex items-center gap-2">
                  <span>{formatDateCN(mainPost.data.date)}</span>
                  {mainPost.data.tags.length > 0 && (
                    <span>{mainPost.data.tags.slice(0, 2).join(' ')}</span>
                  )}
                </div>
              </div>
            </article>
          </a>
        )}

        <!-- Side Cards -->
        {sidePosts.map((post) => (
          <a href={`/blog/${post.slug}`} class="block">
            <article
              class="post-card post-card--small group rounded-2xl overflow-hidden card-premium hover:-translate-y-1 transition-all duration-300 h-full flex flex-col"
              style={`--hover-color: ${getPostColor(post.data.categories)}`}
            >
              <div
                class="post-image h-[120px] relative flex items-start justify-start p-4 overflow-hidden"
              >
                {post.data.image && (
                  <img
                    src={post.data.image}
                    alt={post.data.title}
                    class="absolute inset-0 w-full h-full object-cover"
                  />
                )}
                <!-- Diagonal decorative line -->
                <div class="absolute inset-0 pointer-events-none">
                  <div
                    class="absolute top-1/2 left-0 w-[200%] h-[1px]"
                    style="
                      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                      transform: rotate(-45deg) translateY(-50%);
                      transform-origin: left center;
                    "
                  ></div>
                </div>
                <span
                  class="post-tag relative z-10 inline-block text-white text-xs px-3 py-1 rounded-md"
                  style={`
                    background: rgba(0,0,0,0.4);
                    backdrop-filter: blur(4px);
                    border: 1px solid ${getPostColor(post.data.categories)};
                  `}
                >
                  {post.data.categories[0] || '博客'}
                </span>
              </div>
              <div class="post-content p-6">
                <h3
                  class="text-lg font-bold text-white mb-1 transition-colors"
                  style="font-weight: 700;"
                >
                  {post.data.title}
                </h3>
                <p class="text-[#a3a3a3] text-sm mb-2">
                  {post.data.description}
                </p>
                <div class="post-meta text-[#525252] text-[13px]">
                  {formatDateCN(post.data.date)}
                </div>
              </div>
            </article>
          </a>
        ))}
      </div>
    </div>
  </section>
)}

<style>
  .post-card:hover h3 {
    color: var(--hover-color);
  }
</style>

---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Comments from '../../components/Comments.astro';
import ImagePlaceholder from '../../components/ImagePlaceholder.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import Subscribe from '../../components/Subscribe.astro';
import { getAllPublishedPosts, getPostBySlug, getPostContent, extractHeadings, type Post } from '../../lib/notion-cms.js';
import { calculateReadingTime } from '../../utils/readingTime';
import { Markdown } from '@astropub/md';

export async function getStaticPaths() {
  const posts = await getAllPublishedPosts();
  return posts
    .filter(post => post.type === '博客')
    .map((post) => ({
      params: { slug: post.slug },
      props: { post },
    }));
}

type Props = {
  post: Post;
};

const { post } = Astro.props;

// 获取文章内容（支持 Notion + 本地回退）
const content = await getPostContent(post.id, post.slug, post.type);

// 计算阅读时间
const readingTime = calculateReadingTime(content);

// 从 HTML 内容中提取 headings 用于目录
const headings = extractHeadings(content);

// 分类颜色映射
const categoryColorMap: Record<string, string> = {
  '思考': '#A855F7',
  '技术': '#06B6D4',
  'ACM': '#06B6D4',
  '基础算法': '#06B6D4',
  '项目': '#06B6D4',
  '生活': '#F97316',
  '随笔': '#F97316',
};

const defaultColor = '#A855F7';
const primaryCategory = post.categories?.[0] || '';
const brandColor = categoryColorMap[primaryCategory] || defaultColor;

function formatDate(dateString: string) {
  const date = new Date(dateString);
  return new Intl.DateTimeFormat('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
  }).format(date).replace(/\//g, '.');
}
---

<BaseLayout
  title={post.title}
  description={post.description}
  image={post.image}
  type="article"
>
  <article class="py-12 md:py-20" style={`--brand-color: ${brandColor};`}>
    <!-- Header -->
    <header class="article-header">
      <!-- Meta info -->
      <div class="article-meta">
        {post.categories.length > 0 && (
          <>
            <span class="meta-category">
              <span class="dot"></span>
              {primaryCategory}
            </span>
            <span class="meta-sep">·</span>
          </>
        )}
        <span>{formatDate(post.date)}</span>
        <span class="meta-sep">·</span>
        <span>{readingTime.text}</span>
      </div>

      <!-- Title -->
      <h1 class="article-title">{post.title}</h1>

      <!-- Description (optional) -->
      {post.description && (
        <p class="article-description">{post.description}</p>
      )}

      <!-- Divider -->
      <hr class="article-divider" />

      <!-- Cover Image -->
      <div class="article-cover-wrapper">
        {post.image ? (
          <img
            src={post.image}
            alt={post.title}
            class="article-cover"
          />
        ) : (
          <ImagePlaceholder alt={post.title} aspectRatio="21/9" class="article-cover" />
        )}
      </div>
    </header>

    <!-- Main Content with TOC -->
    <div class="article-layout">
      <!-- Content -->
      <div class="article-main">
        <div class="article-content" set:html={content} />

        <!-- Tags -->
        {post.tags.length > 0 && (
          <div class="mt-12 pt-8 border-t border-[var(--border-color)]">
            <div class="flex flex-wrap gap-2">
              {post.tags.map(tag => (
                <a
                  href={`/blog/tags/${tag.toLowerCase()}`}
                  class="px-3 py-1 bg-[var(--bg-secondary)] rounded-full text-sm text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors"
                >
                  #{tag}
                </a>
              ))}
            </div>
          </div>
        )}

        <!-- Subscribe -->
        <div class="mt-16 pt-12 border-t border-[var(--border-color)]">
          <Subscribe />
        </div>

        <!-- Comments -->
        <div class="mt-16 pt-12 border-t border-[var(--border-color)]">
          <Comments />
        </div>
      </div>

      <!-- TOC Sidebar -->
      <aside class="article-toc">
        <TableOfContents headings={headings} />
      </aside>
    </div>
  </article>
</BaseLayout>

<style>
  /* Article Header */
  .article-header {
    max-width: var(--max-width-article, 720px);
    margin: 0 auto 3rem;
    padding: 0 1rem;
  }

  @media (min-width: 640px) {
    .article-header {
      padding: 0 1.5rem;
    }
  }

  @media (min-width: 1024px) {
    .article-header {
      padding: 0 2rem;
    }
  }

  /* Meta Info */
  .article-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 14px;
    color: #9CA3AF;
    margin-bottom: 1.25rem;
  }

  .meta-category {
    color: var(--brand-color);
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }

  .meta-category .dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--brand-color);
  }

  .meta-sep {
    color: #374151;
  }

  /* Title */
  .article-title {
    font-size: 30px;
    font-weight: 700;
    color: #ffffff;
    line-height: 1.3;
    margin-bottom: 0.75rem;
  }

  @media (min-width: 768px) {
    .article-title {
      font-size: 32px;
    }
  }

  /* Description */
  .article-description {
    font-size: 16px;
    color: #9CA3AF;
    line-height: 1.6;
    margin-bottom: 1.5rem;
  }

  /* Divider */
  .article-divider {
    border: none;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 2rem;
  }

  /* Cover Image */
  .article-cover-wrapper {
    margin-bottom: 0;
  }

  .article-cover {
    width: 100%;
    border-radius: 8px;
    aspect-ratio: 21/9;
    object-fit: cover;
  }

  /* Two-column Layout */
  .article-layout {
    display: grid;
    grid-template-columns: 1fr 250px;
    gap: 3rem;
    max-width: var(--max-width-wide, 1200px);
    margin: 0 auto;
    padding: 0 1rem;
  }

  @media (min-width: 640px) {
    .article-layout {
      padding: 0 1.5rem;
    }
  }

  @media (min-width: 1024px) {
    .article-layout {
      padding: 0 2rem;
    }
  }

  .article-main {
    min-width: 0;
  }

  /* TOC Sidebar - Critical: allow grid item to stretch for sticky to work */
  .article-toc {
    display: block;
    position: relative; /* Create new containing block */
  }

  /* Content Link Styles */
  .article-content :global(a) {
    color: #A855F7;
    text-decoration: underline;
    text-underline-offset: 3px;
    transition: opacity 0.3s ease;
  }

  .article-content :global(a:hover) {
    opacity: 0.8;
  }

  /* Responsive */
  @media (max-width: 1280px) {
    .article-layout {
      grid-template-columns: 1fr;
    }

    .article-toc {
      display: none;
    }
  }
</style>

---
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import RelatedVideos from '../../components/RelatedVideos.astro';
import ContentNavigation from '../../components/ContentNavigation.astro';
import ShareButtons from '../../components/ShareButtons.astro';
import { formatDateFull } from '../../utils/date';
import { getPlatformName, getVideoUrl, getVideoEmbedUrl, type VideoPlatform } from '../../utils/platform';

export async function getStaticPaths() {
  const videos = await getCollection('videos');
  return videos.map((video) => ({
    params: { slug: video.slug },
    props: { video },
  }));
}

type Props = {
  video: CollectionEntry<'videos'>;
};

const { video } = Astro.props;
const { Content } = await video.render();

// Get all videos for related and navigation
const allVideos = await getCollection('videos');
const sortedVideos = allVideos.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
const currentIndex = sortedVideos.findIndex(v => v.slug === video.slug);
const prevVideo = currentIndex < sortedVideos.length - 1 ? sortedVideos[currentIndex + 1] : undefined;
const nextVideo = currentIndex > 0 ? sortedVideos[currentIndex - 1] : undefined;

const platform = video.data.platform as VideoPlatform;
const videoUrl = getVideoUrl(video.data.videoId, platform);
const embedUrl = getVideoEmbedUrl(video.data.videoId, platform);
const platformName = getPlatformName(platform);
const canonicalURL = new URL(`/videos/${video.slug}`, Astro.site || 'https://amiwrr.blog').toString();
---

<BaseLayout
  title={video.data.title}
  description={video.data.description}
  image={video.data.thumbnail}
  type="article"
>
  <article class="py-12 md:py-20">
    <!-- Header - Centered Layout -->
    <header class="max-w-medium mx-auto px-4 sm:px-6 lg:px-8 text-center mb-10">
      <!-- Meta Info Row -->
      <div class="flex items-center justify-center gap-2 text-sm mb-4">
        <span class="text-[#F97316] font-medium">{platformName}</span>
        <span class="text-[var(--text-muted)]">·</span>
        <span class="text-[var(--text-secondary)]">{formatDateFull(video.data.date)}</span>
      </div>

      <h1 class="text-2xl md:text-3xl font-bold mb-3">
        {video.data.title}
      </h1>

      <p class="text-base text-[var(--text-secondary)] max-w-2xl mx-auto mb-5">
        {video.data.description}
      </p>

      <!-- External Link Button -->
      <div class="flex justify-center mb-6">
        <a
          href={videoUrl}
          target="_blank"
          rel="noopener noreferrer"
          class="video-btn"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
            <polyline points="15 3 21 3 21 9"></polyline>
            <line x1="10" y1="14" x2="21" y2="3"></line>
          </svg>
          在 {platformName} 观看
        </a>
      </div>

      <!-- Divider -->
      <div class="border-b border-[rgba(255,255,255,0.1)]"></div>
    </header>

    <!-- Video Embed -->
    <div class="max-w-wide mx-auto px-4 sm:px-6 lg:px-8 mb-10">
      <div class="relative">
        <!-- Corner Link -->
        <a
          href={videoUrl}
          target="_blank"
          rel="noopener noreferrer"
          class="absolute top-3 right-3 z-10 text-xs text-[var(--text-muted)] hover:text-[#F97316] transition-colors flex items-center gap-1 bg-black/40 backdrop-blur-sm px-2 py-1 rounded"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
            <polyline points="15 3 21 3 21 9"></polyline>
            <line x1="10" y1="14" x2="21" y2="3"></line>
          </svg>
          在 {platformName} 观看
        </a>
        <!-- iframe -->
        <div class="aspect-video rounded-lg overflow-hidden bg-black">
          <iframe
            src={embedUrl}
            title={video.data.title}
            class="w-full h-full"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
          ></iframe>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="max-w-article mx-auto px-4 sm:px-6 lg:px-8">
      <div class="article-content">
        <Content />
      </div>

      <!-- Share Buttons -->
      <div class="mt-12 pt-8 border-t border-[var(--border-color)]">
        <ShareButtons
          title={video.data.title}
          url={canonicalURL}
          description={video.data.description}
        />
      </div>

      <!-- Navigation -->
      <ContentNavigation
        prev={prevVideo ? { slug: prevVideo.slug, data: { title: prevVideo.data.title } } : undefined}
        next={nextVideo ? { slug: nextVideo.slug, data: { title: nextVideo.data.title } } : undefined}
        basePath="/videos"
        prevLabel="上一个视频"
        nextLabel="下一个视频"
      />

      <!-- Related Videos -->
      <RelatedVideos
        currentSlug={video.slug}
        platform={platform}
        allVideos={sortedVideos}
      />
    </div>
  </article>
</BaseLayout>

<style>
  .video-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 0.25rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
    transition: all 0.3s ease;
  }
  .video-btn:hover {
    border-color: #F97316;
    color: #F97316;
    background: rgba(249, 115, 22, 0.1);
  }
</style>
---
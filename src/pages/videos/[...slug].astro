---
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import RelatedVideos from '../../components/RelatedVideos.astro';
import ContentNavigation from '../../components/ContentNavigation.astro';
import ShareButtons from '../../components/ShareButtons.astro';
import { formatDateFull } from '../../utils/date';
import { getPlatformName, getPlatformIcon, getVideoUrl, type VideoPlatform } from '../../utils/platform';

export async function getStaticPaths() {
  const videos = await getCollection('videos');
  return videos.map((video) => ({
    params: { slug: video.slug },
    props: { video },
  }));
}

type Props = {
  video: CollectionEntry<'videos'>;
};

const { video } = Astro.props;
const { Content } = await video.render();

// Get all videos for related and navigation
const allVideos = await getCollection('videos');
const sortedVideos = allVideos.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
const currentIndex = sortedVideos.findIndex(v => v.slug === video.slug);
const prevVideo = currentIndex < sortedVideos.length - 1 ? sortedVideos[currentIndex + 1] : undefined;
const nextVideo = currentIndex > 0 ? sortedVideos[currentIndex - 1] : undefined;

const platform = video.data.platform as VideoPlatform;
const videoUrl = getVideoUrl(video.data.videoId, platform);
const canonicalURL = new URL(`/videos/${video.slug}`, Astro.site || 'https://amiwrr.blog').toString();
---

<BaseLayout
  title={video.data.title}
  description={video.data.description}
  image={video.data.thumbnail}
  type="article"
>
  <article class="py-12 md:py-20">
    <!-- Header -->
    <header class="max-w-medium mx-auto px-4 sm:px-6 lg:px-8 text-center mb-12">
      <!-- Platform Badge -->
      <div class="flex justify-center mb-4">
        <span class="inline-flex items-center gap-2 px-4 py-2 bg-[var(--bg-secondary)] rounded-full text-sm text-[var(--text-secondary)]">
          <Fragment set:html={getPlatformIcon(platform)} />
          {getPlatformName(platform)}
        </span>
      </div>

      <h1 class="text-3xl md:text-4xl lg:text-5xl font-serif font-bold mb-4">
        {video.data.title}
      </h1>

      <p class="text-lg text-[var(--text-secondary)] mb-6">
        {video.data.description}
      </p>

      <div class="flex items-center justify-center gap-4 text-sm text-[var(--text-muted)]">
        <span>{formatDateFull(video.data.date)}</span>
      </div>
    </header>

    <!-- Video Cover with Play Button -->
    <div class="max-w-medium mx-auto px-4 sm:px-6 lg:px-8 mb-12">
      <a
        href={videoUrl}
        target="_blank"
        rel="noopener noreferrer"
        class="group relative block w-full aspect-video rounded-xl overflow-hidden bg-black"
      >
        {video.data.thumbnail ? (
          <img
            src={video.data.thumbnail}
            alt={video.data.title}
            class="w-full h-full object-cover opacity-90 group-hover:opacity-100 group-hover:scale-105 transition-all duration-500"
          />
        ) : (
          <div class="w-full h-full bg-gradient-to-br from-[var(--bg-secondary)] to-[var(--bg-tertiary)] flex items-center justify-center">
            <svg class="w-20 h-20 text-[var(--text-muted)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
        )}
        <!-- Play Button Overlay -->
        <div class="absolute inset-0 flex items-center justify-center">
          <div class="w-20 h-20 bg-white/90 rounded-full flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
            <svg class="w-8 h-8 text-[var(--text-primary)] ml-1" fill="currentColor" viewBox="0 0 24 24">
              <path d="M8 5v14l11-7z"/>
            </svg>
          </div>
        </div>
        <!-- External Link Indicator -->
        <div class="absolute top-4 right-4 bg-black/60 text-white px-3 py-1 rounded-full text-xs flex items-center gap-1">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
          </svg>
          在 {getPlatformName(platform)} 观看
        </div>
      </a>
    </div>

    <!-- Content -->
    <div class="max-w-article mx-auto px-4 sm:px-6 lg:px-8">
      <div class="article-content">
        <Content />
      </div>

      <!-- External Link Button -->
      <div class="mt-12 pt-8 border-t border-[var(--border-color)] text-center">
        <a
          href={videoUrl}
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 px-8 py-4 bg-[var(--text-primary)] text-[var(--bg-primary)] rounded-lg font-medium hover:opacity-90 transition-opacity"
        >
          <Fragment set:html={getPlatformIcon(platform)} />
          在 {getPlatformName(platform)} 上观看
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
          </svg>
        </a>
      </div>

      <!-- Share Buttons -->
      <div class="mt-12 pt-8 border-t border-[var(--border-color)]">
        <ShareButtons
          title={video.data.title}
          url={canonicalURL}
          description={video.data.description}
        />
      </div>

      <!-- Navigation -->
      <ContentNavigation
        prev={prevVideo ? { slug: prevVideo.slug, data: { title: prevVideo.data.title } } : undefined}
        next={nextVideo ? { slug: nextVideo.slug, data: { title: nextVideo.data.title } } : undefined}
        basePath="/videos"
        prevLabel="上一个视频"
        nextLabel="下一个视频"
      />

      <!-- Related Videos -->
      <RelatedVideos
        currentSlug={video.slug}
        platform={platform}
        allVideos={sortedVideos}
      />
    </div>
  </article>
</BaseLayout>
